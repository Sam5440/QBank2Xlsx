<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é¢˜åº“ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            padding: 32px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            padding: 48px 56px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
        }
        h1 {
            margin-bottom: 40px;
            color: #111827;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
            padding-bottom: 16px;
            border-bottom: 3px solid #6366f1;
        }
        .section {
            margin-bottom: 32px;
            padding: 28px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .section:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: #111827;
            font-size: 17px;
            letter-spacing: -0.01em;
        }
        .question-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 14px;
        }
        .type-item {
            display: flex;
            gap: 0;
            align-items: stretch;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .type-item:hover {
            border-color: #c7d2fe;
            box-shadow: 0 2px 8px rgba(99,102,241,0.1);
        }
        .type-btn {
            padding: 14px 18px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            text-align: center;
            flex: 1;
        }
        .type-item.active {
            border-color: #6366f1;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 12px rgba(99,102,241,0.25);
        }
        .type-item.active .type-btn {
            color: white;
            font-weight: 600;
        }
        .type-item.active .action-btns button {
            color: white;
            border-left-color: rgba(255,255,255,0.25);
        }
        .action-btns {
            display: flex;
            border-left: 1px solid #e5e7eb;
        }
        .action-btns button {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            color: #6366f1;
            border-left: 1px solid #e5e7eb;
            font-weight: 500;
        }
        .action-btns button:first-child {
            border-left: none;
        }
        .action-btns button:hover {
            background: rgba(99,102,241,0.08);
        }
        .notice-tip {
            padding: 14px 18px;
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 8px;
            color: #dc2626;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 18px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #111827;
            background: white;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        input:hover, textarea:hover, select:hover {
            border-color: #d1d5db;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            line-height: 1.7;
        }
        .api-config {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .api-row {
            display: grid;
            grid-template-columns: 40px 150px 1fr 1fr 150px 90px;
            gap: 12px;
            align-items: center;
            padding: 18px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .api-row:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .api-row input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #6366f1;
        }
        .api-row input[type="text"],
        .api-row input[type="password"] {
            margin: 0;
        }
        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(99,102,241,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99,102,241,0.35);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        button.small {
            padding: 10px 18px;
            font-size: 14px;
            box-shadow: 0 1px 4px rgba(99,102,241,0.15);
        }
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239,68,68,0.2);
        }
        button.danger:hover {
            box-shadow: 0 6px 20px rgba(239,68,68,0.35);
        }
        .output {
            background: #1f2937;
            color: #f3f4f6;
            border: 2px solid #374151;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.7;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .output.invalid {
            border: 3px solid #ef4444;
            background: #fef2f2;
            color: #dc2626;
            box-shadow: 0 0 0 3px rgba(239,68,68,0.1);
        }
        .validation-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 6px;
            font-weight: 600;
        }
        .actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        .error {
            color: #dc2626;
            margin-top: 12px;
            padding: 14px 16px;
            background: #fef2f2;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
            font-weight: 500;
            font-size: 14px;
        }
        .label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .input-pair {
            margin-bottom: 18px;
            position: relative;
        }
        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .char-count {
            font-size: 13px;
            color: #6366f1;
            font-weight: 600;
        }
        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .output-pair {
            margin-bottom: 20px;
            padding-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }
        .output-pair:last-child {
            border-bottom: none;
        }
        .placeholder {
            color: #ef4444;
            font-weight: 600;
            background: #fef2f2;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .log-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 480px;
            height: 420px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            min-width: 320px;
            min-height: 220px;
            max-width: 90vw;
            max-height: 90vh;
        }
        .log-panel.minimized {
            width: 220px;
            height: auto;
            resize: none;
        }
        .log-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            font-size: 15px;
        }
        .log-header-buttons {
            display: flex;
            gap: 10px;
        }
        .log-content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }
        .log-panel.minimized .log-content {
            display: none;
        }
        .log-entry {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #6366f1;
            transition: all 0.2s ease;
        }
        .log-entry:hover {
            background: #f3f4f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .log-time {
            color: #6b7280;
            font-size: 10px;
        }
        .log-action {
            color: #111827;
            font-weight: 600;
            margin: 3px 0;
        }
        .log-detail {
            color: #4b5563;
            font-size: 11px;
        }
        .btn-clear {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .btn-clear:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 36px;
            border-radius: 16px;
            width: 80%;
            max-width: 960px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,0,0,0.05);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }
        .modal-title {
            font-size: 26px;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.02em;
        }
        .close-btn {
            font-size: 32px;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 36px;
            height: 36px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .close-btn:hover {
            color: #111827;
            background: #f3f4f6;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <div class="log-panel" id="logPanel">
        <div class="log-header" id="logHeader">
            ğŸ“‹ æ“ä½œæ—¥å¿—
            <div class="log-header-buttons">
                <button class="btn-clear" onclick="toggleMinimize()">âˆ’</button>
                <button class="btn-clear" onclick="clearLogs()">æ¸…ç©º</button>
            </div>
        </div>
        <div class="log-content" id="logContent"></div>
    </div>
    <div class="container">
        <h1>ğŸ“ AI é¢˜åº“ç”Ÿæˆå™¨</h1>

        <div class="section">
            <div class="section-title">1ï¸âƒ£ é€‰æ‹©é¢˜å‹ï¼ˆå¯å¤šé€‰ï¼‰</div>
            <div id="noticeTipContainer"></div>
            <div class="question-types" id="questionTypesContainer">
                <div style="color: #718096; padding: 20px; text-align: center;">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2ï¸âƒ£ API é…ç½®ç®¡ç† <span style="color: #718096; font-size: 14px; font-weight: normal;">(API URL éœ€è¦å¸¦ /v1ï¼Œä¾‹å¦‚: https://api.openai.com/v1)</span></div>
            <div class="api-config" id="apiConfigs"></div>
            <button class="small" onclick="addApiConfig()" style="margin-top: 10px;">â• æ·»åŠ  API é…ç½®</button>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin: 0;">ğŸ“‹ ç³»ç»Ÿæç¤ºè¯</div>
                <button class="small" onclick="resetSystemPrompt()">ğŸ”„ è¿˜åŸé»˜è®¤</button>
            </div>
            <textarea id="systemPrompt" style="min-height: 200px; font-family: 'Courier New', monospace;"></textarea>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="section-title" style="margin: 0;">ğŸ“‘ ç›®å½•ç»“æ„</div>
                <button class="small" onclick="extractDirectory()">ğŸ¤– AI æå–ç›®å½•</button>
            </div>
            <textarea id="directory" placeholder="è¾“å…¥æˆ–æå–ç›®å½•ç»“æ„..." style="min-height: 120px;"></textarea>
        </div>

        <div class="section">
            <div class="section-title">3ï¸âƒ£ è¾“å…¥é¢˜ç›®éœ€æ±‚</div>
            <div id="inputPairs"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="small" onclick="addInputPair()">â• æ·»åŠ è¾“å…¥</button>
                <button class="small" onclick="exportInputs()">ğŸ’¾ å¯¼å‡ºåˆ‡åˆ†</button>
                <button class="small" onclick="importInputs()">ğŸ“‚ å¯¼å…¥åˆ‡åˆ†</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>

        <div class="section">
            <div class="section-title">è¾“å‡ºæ–‡ä»¶å</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="outputFilename" value="exam_questions" placeholder="è¾“å‡ºæ–‡ä»¶å" style="flex: 1;">
                <button class="small" onclick="generateFilename()">ğŸ¤– AI ç”Ÿæˆ</button>
            </div>
        </div>

        <div class="section">
            <div style="display: flex; align-items: center; gap: 20px;">
                <button id="generateBtn" onclick="generateQuestions()">ğŸš€ ç”Ÿæˆé¢˜ç›®</button>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="streamToggle" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; color: #2d3748;">æµå¼è¾“å‡º</span>
                </label>
            </div>
        </div>

        <div class="section">
            <div class="section-title">4ï¸âƒ£ AI ç”Ÿæˆç»“æœ</div>
            <div id="outputPairs"></div>
            <div class="error" id="error" style="display: none;"></div>
        </div>

        <div class="actions">
            <button id="exportBtn" onclick="exportExcel()" disabled>ğŸ“¥ å¯¼å‡º Excel</button>
        </div>

        <div class="section">
            <div class="section-title">5ï¸âƒ£ AB å¯¹æ¯”å®¡æ ¸</div>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="removeNullToggle" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; color: #2d3748;">å»é™¤ null å€¼</span>
                </label>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <div style="font-size: 14px; color: #718096; margin-bottom: 8px; font-weight: 600;">ğŸ“„ æ–‡ä»¶ Aï¼ˆç”Ÿæˆçš„é¢˜ç›®ï¼‰</div>
                    <textarea id="fileA" style="min-height: 200px; font-family: 'Courier New', monospace;" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆ..."></textarea>
                </div>
                <div>
                    <div style="font-size: 14px; color: #718096; margin-bottom: 8px; font-weight: 600;">ğŸ“‹ æ–‡ä»¶ Bï¼ˆåŸå§‹éœ€æ±‚ï¼‰</div>
                    <textarea id="fileB" style="min-height: 200px; font-family: 'Courier New', monospace;" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆ..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="small" onclick="generateFileA()">ç”Ÿæˆæ–‡ä»¶ A</button>
                <button class="small" onclick="generateFileB()">ç”Ÿæˆæ–‡ä»¶ B</button>
                <button id="compareBtn" onclick="compareFiles()" disabled>ğŸ” AI å¯¹æ¯”åˆ†æ</button>
                <button class="small" onclick="compareAllSingle()">ğŸš€ ä¸€é”®å…¨éƒ¨å®¡æ ¸</button>
            </div>
            <div>
                <div style="font-size: 14px; color: #718096; margin-bottom: 8px; font-weight: 600;">ğŸ“Š å¯¹æ¯”ç»“æœ</div>
                <div class="output" id="compareResult">ç­‰å¾…å¯¹æ¯”...</div>
            </div>
        </div>
    </div>

    <div id="jsonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">JSON é¢„è§ˆ</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="output" id="modalContent" style="max-height: 60vh;"></div>
        </div>
    </div>

    <script>
        let selectedTypes = [];
        let generatedJSON = '';
        let encryptionKey = '';
        let apiConfigs = [];
        let inputPairs = [{id: 0, text: ''}];
        let outputPairs = [{id: 0, editable: '', full: ''}];
        let nextId = 1;
        let defaultSystemPrompt = '';
        let sampleData = {};

        // æ—¥å¿—ç³»ç»Ÿ
        function addLog(action, detail = '') {
            const logs = JSON.parse(localStorage.getItem('aiLogs') || '[]');
            const log = {
                time: new Date().toLocaleString('zh-CN'),
                action,
                detail
            };
            logs.unshift(log);
            if (logs.length > 50) logs.splice(50);
            localStorage.setItem('aiLogs', JSON.stringify(logs));
            renderLogs();
        }

        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem('aiLogs') || '[]');
            const container = document.getElementById('logContent');
            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <div class="log-time">${log.time}</div>
                    <div class="log-action">${log.action}</div>
                    ${log.detail ? `<div class="log-detail">${log.detail}</div>` : ''}
                </div>
            `).join('');
        }

        function clearLogs() {
            localStorage.removeItem('aiLogs');
            renderLogs();
            addLog('æ¸…ç©ºæ—¥å¿—', 'æ‰€æœ‰æ—¥å¿—å·²æ¸…é™¤');
        }

        function toggleMinimize() {
            const panel = document.getElementById('logPanel');
            const btn = event.target;
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '+' : 'âˆ’';
            localStorage.setItem('logMinimized', panel.classList.contains('minimized'));
        }

        // Drag functionality
        let isDragging = false;
        let currentX, currentY, initialX, initialY;

        document.getElementById('logHeader').addEventListener('mousedown', (e) => {
            isDragging = true;
            const panel = document.getElementById('logPanel');
            const rect = panel.getBoundingClientRect();
            initialX = e.clientX - rect.left;
            initialY = e.clientY - rect.top;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                const panel = document.getElementById('logPanel');
                panel.style.transform = 'none';
                panel.style.left = (e.clientX - initialX) + 'px';
                panel.style.top = (e.clientY - initialY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        async function loadSystemPrompt() {
            try {
                const response = await fetch('/api/system-prompt');
                const data = await response.json();
                defaultSystemPrompt = data.systemPrompt;
                document.getElementById('systemPrompt').value = defaultSystemPrompt;
            } catch (e) {
                console.error('åŠ è½½ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', e);
            }
        }

        async function loadQuestionTypes() {
            try {
                const response = await fetch('/api/question-types');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('questionTypesContainer').innerHTML =
                        `<div style="color: #e53e3e; padding: 20px; text-align: center;">åŠ è½½å¤±è´¥: ${data.error}</div>`;
                    return;
                }

                sampleData = data.sampleData;
                const types = data.questionTypes || [];
                const noticeTip = data.noticeTip;

                // Display notice tip if exists
                const noticeTipContainer = document.getElementById('noticeTipContainer');
                if (noticeTip) {
                    noticeTipContainer.innerHTML = `<div class="notice-tip">âš ï¸ ${noticeTip}</div>`;
                } else {
                    noticeTipContainer.innerHTML = '';
                }

                if (types.length === 0) {
                    document.getElementById('questionTypesContainer').innerHTML =
                        '<div style="color: #718096; padding: 20px; text-align: center;">æœªæ‰¾åˆ°é¢˜å‹</div>';
                    return;
                }

                // Count examples for each type
                const typeCounts = {};
                types.forEach(type => {
                    const count = sampleData.questions?.filter(q => q['é¢˜å‹ ï¼ˆå¿…å¡«ï¼‰'] === type).length || 0;
                    typeCounts[type] = count;
                });

                const container = document.getElementById('questionTypesContainer');
                container.innerHTML = types.map(type =>
                    `<div class="type-item" data-type="${type}">
                        <button class="type-btn">${type}</button>
                        <div class="action-btns">
                            <button onclick="showExplanation('${type}')" title="è¯´æ˜">æ˜</button>
                            <button onclick="previewJSON('${type}')" title="é¢„è§ˆç¤ºä¾‹">${typeCounts[type]}</button>
                        </div>
                    </div>`
                ).join('');

                document.querySelectorAll('.type-item').forEach(item => {
                    const typeBtn = item.querySelector('.type-btn');
                    typeBtn.addEventListener('click', () => {
                        const type = item.dataset.type;
                        item.classList.toggle('active');
                        if (selectedTypes.includes(type)) {
                            selectedTypes = selectedTypes.filter(t => t !== type);
                            addLog('å–æ¶ˆé¢˜å‹', type);
                        } else {
                            selectedTypes.push(type);
                            addLog('é€‰æ‹©é¢˜å‹', type);
                        }
                        setCookie('questionTypes', encrypt(JSON.stringify(selectedTypes)));
                    });
                });

                const savedTypes = getCookie('questionTypes');
                if (savedTypes) {
                    const decrypted = decrypt(savedTypes);
                    if (decrypted) {
                        selectedTypes = JSON.parse(decrypted);
                        selectedTypes.forEach(type => {
                            document.querySelector(`.type-item[data-type="${type}"]`)?.classList.add('active');
                        });
                    }
                }

                addLog('åŠ è½½é¢˜å‹', `å…± ${types.length} ç§é¢˜å‹`);
            } catch (e) {
                console.error('åŠ è½½é¢˜å‹å¤±è´¥:', e);
                document.getElementById('questionTypesContainer').innerHTML =
                    `<div style="color: #e53e3e; padding: 20px; text-align: center;">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        function showExplanation(type) {
            const explanations = {
                'å•é€‰é¢˜': 'å•é€‰é¢˜ï¼šåªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œç­”æ¡ˆæ ¼å¼ä¸ºå•ä¸ªå­—æ¯ï¼ˆå¦‚ "A"ï¼‰',
                'å¤šé€‰é¢˜': 'å¤šé€‰é¢˜ï¼šæœ‰å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œç­”æ¡ˆæ ¼å¼ä¸ºå¤šä¸ªå­—æ¯ï¼ˆå¦‚ "ABCD"ï¼‰',
                'ä¸å®šé¡¹é€‰æ‹©é¢˜': 'ä¸å®šé¡¹é€‰æ‹©é¢˜ï¼šå¯èƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œç­”æ¡ˆæ ¼å¼ä¸ºå­—æ¯ç»„åˆï¼ˆå¦‚ "AB"ï¼‰',
                'åˆ¤æ–­é¢˜': 'åˆ¤æ–­é¢˜ï¼šåˆ¤æ–­å¯¹é”™ï¼Œç­”æ¡ˆæ ¼å¼ä¸º "A"ï¼ˆæ­£ç¡®ï¼‰æˆ– "B"ï¼ˆé”™è¯¯ï¼‰',
                'å¡«ç©ºé¢˜': 'å¡«ç©ºé¢˜ï¼šå¡«å†™ç­”æ¡ˆï¼Œç­”æ¡ˆå¯ä»¥åœ¨"é€‰é¡¹ A"æˆ–"æ­£ç¡®ç­”æ¡ˆ"å­—æ®µä¸­',
                'ç®€ç­”é¢˜': 'ç®€ç­”é¢˜ï¼šéœ€è¦æ–‡å­—å›ç­”ï¼Œç­”æ¡ˆåœ¨"æ­£ç¡®ç­”æ¡ˆ"å­—æ®µä¸­',
                'æ’åºé¢˜': 'æ’åºé¢˜ï¼šå¯¹é€‰é¡¹è¿›è¡Œæ’åºï¼Œç­”æ¡ˆæ ¼å¼ä¸ºå­—æ¯åºåˆ—ï¼ˆå¦‚ "DBAC"ï¼‰',
                'è®¡ç®—é¢˜': 'è®¡ç®—é¢˜ï¼šéœ€è¦è®¡ç®—çš„é¢˜ç›®ï¼Œç­”æ¡ˆåœ¨"æ­£ç¡®ç­”æ¡ˆ"å­—æ®µä¸­',
                'è®ºè¿°é¢˜': 'è®ºè¿°é¢˜ï¼šéœ€è¦è¯¦ç»†è®ºè¿°ï¼Œç­”æ¡ˆåœ¨"æ­£ç¡®ç­”æ¡ˆ"å­—æ®µä¸­'
            };

            const explanation = explanations[type] || 'æš‚æ— è¯´æ˜';
            alert(explanation);
            addLog('æŸ¥çœ‹è¯´æ˜', type);
        }

        function previewJSON(section) {
            const modal = document.getElementById('jsonModal');
            const content = document.getElementById('modalContent');

            if (section === 'questionTypes') {
                content.textContent = JSON.stringify(sampleData, null, 2);
            } else {
                // Filter questions by type
                const filteredData = {
                    questions: sampleData.questions?.filter(q => q['é¢˜å‹ ï¼ˆå¿…å¡«ï¼‰'] === section) || []
                };
                content.textContent = JSON.stringify(filteredData, null, 2);
            }

            modal.style.display = 'block';
            addLog('é¢„è§ˆJSON', section);
        }

        function closeModal() {
            document.getElementById('jsonModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('jsonModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function resetSystemPrompt() {
            document.getElementById('systemPrompt').value = defaultSystemPrompt;
            addLog('è¿˜åŸç³»ç»Ÿæç¤ºè¯', 'å·²æ¢å¤ä¸ºé»˜è®¤æç¤ºè¯');
        }

        async function extractDirectory() {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('AIæå–ç›®å½•å¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            const allInputs = inputPairs.map(p => p.text).filter(t => t.trim()).join('\n\n');
            if (!allInputs) {
                error.textContent = 'âŒ è¯·å…ˆè¾“å…¥é¢˜ç›®éœ€æ±‚';
                error.style.display = 'block';
                addLog('AIæå–ç›®å½•å¤±è´¥', 'è¾“å…¥å†…å®¹ä¸ºç©º');
                return;
            }

            addLog('AIæå–ç›®å½•', `ä½¿ç”¨æ¨¡å‹: ${selectedApi.model}`);
            try {
                const response = await fetch('/api/extract-directory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiUrl: selectedApi.url,
                        apiKey: selectedApi.key,
                        model: selectedApi.model,
                        content: allInputs
                    })
                });

                const data = await response.json();
                if (data.directory) {
                    document.getElementById('directory').value = data.directory;
                    addLog('AIæå–ç›®å½•æˆåŠŸ', `æå–äº† ${data.directory.split('\n').length} è¡Œç›®å½•`);
                } else if (data.error) {
                    error.textContent = 'âŒ ' + data.error;
                    error.style.display = 'block';
                    addLog('AIæå–ç›®å½•å¤±è´¥', data.error);
                }
            } catch (e) {
                error.textContent = `âŒ æå–å¤±è´¥: ${e.message}`;
                error.style.display = 'block';
                addLog('AIæå–ç›®å½•å¼‚å¸¸', e.message);
            }
        }

        async function generateFilename() {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('AIç”Ÿæˆæ–‡ä»¶åå¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            const allInputs = inputPairs.map(p => p.text).filter(t => t.trim()).join('\n\n');
            if (!allInputs) {
                error.textContent = 'âŒ è¯·å…ˆè¾“å…¥é¢˜ç›®éœ€æ±‚';
                error.style.display = 'block';
                addLog('AIç”Ÿæˆæ–‡ä»¶åå¤±è´¥', 'è¾“å…¥å†…å®¹ä¸ºç©º');
                return;
            }

            addLog('AIç”Ÿæˆæ–‡ä»¶å', `ä½¿ç”¨æ¨¡å‹: ${selectedApi.model}`);
            try {
                const response = await fetch('/api/generate-filename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiUrl: selectedApi.url,
                        apiKey: selectedApi.key,
                        model: selectedApi.model,
                        content: allInputs
                    })
                });

                const data = await response.json();
                if (data.filename) {
                    document.getElementById('outputFilename').value = data.filename;
                    addLog('AIç”Ÿæˆæ–‡ä»¶åæˆåŠŸ', `æ–‡ä»¶å: ${data.filename}`);
                } else if (data.error) {
                    error.textContent = 'âŒ ' + data.error;
                    error.style.display = 'block';
                    addLog('AIç”Ÿæˆæ–‡ä»¶åå¤±è´¥', data.error);
                }
            } catch (e) {
                error.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${e.message}`;
                error.style.display = 'block';
                addLog('AIç”Ÿæˆæ–‡ä»¶åå¼‚å¸¸', e.message);
            }
        }

        async function loadEncryptionKey() {
            const response = await fetch('/api/encryption-key');
            const data = await response.json();
            encryptionKey = data.key;
        }

        function encrypt(text) {
            return CryptoJS.AES.encrypt(text, encryptionKey).toString();
        }

        function decrypt(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, encryptionKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch {
                return '';
            }
        }

        function setCookie(name, value, days = 365) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        }

        function saveConfigs() {
            const encrypted = encrypt(JSON.stringify(apiConfigs));
            setCookie('apiConfigs', encrypted);
        }

        function loadConfigs() {
            const encrypted = getCookie('apiConfigs');
            if (encrypted) {
                const decrypted = decrypt(encrypted);
                if (decrypted) {
                    apiConfigs = JSON.parse(decrypted);
                }
            }
            if (apiConfigs.length === 0) {
                apiConfigs = [{name: 'OpenAI', url: 'https://api.openai.com/v1', key: '', model: 'gpt-4', selected: true}];
            }
            renderApiConfigs();
        }

        function renderApiConfigs() {
            const container = document.getElementById('apiConfigs');
            container.innerHTML = apiConfigs.map((config, idx) => `
                <div class="api-row">
                    <input type="radio" name="selectedApi" ${config.selected ? 'checked' : ''} onchange="selectApi(${idx})">
                    <input type="text" placeholder="åç§°" value="${config.name}" onchange="updateConfig(${idx}, 'name', this.value)">
                    <input type="text" placeholder="API URL" value="${config.url}" onchange="updateConfig(${idx}, 'url', this.value)">
                    <input type="password" placeholder="API Key" value="${config.key}" onchange="updateConfig(${idx}, 'key', this.value)">
                    <input type="text" placeholder="Model" value="${config.model}" onchange="updateConfig(${idx}, 'model', this.value)">
                    <button class="small danger" onclick="deleteConfig(${idx})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function addApiConfig() {
            apiConfigs.push({name: 'æ–°é…ç½®', url: '', key: '', model: '', selected: false});
            renderApiConfigs();
            addLog('æ·»åŠ APIé…ç½®', 'æ–°å¢äº†ä¸€ä¸ªAPIé…ç½®');
        }

        function deleteConfig(idx) {
            const configName = apiConfigs[idx].name;
            apiConfigs.splice(idx, 1);
            if (apiConfigs.length === 0) {
                addApiConfig();
            }
            saveConfigs();
            renderApiConfigs();
            addLog('åˆ é™¤APIé…ç½®', `åˆ é™¤äº†é…ç½®: ${configName}`);
        }

        function selectApi(idx) {
            apiConfigs.forEach((c, i) => c.selected = i === idx);
            saveConfigs();
            addLog('åˆ‡æ¢APIé…ç½®', `é€‰æ‹©äº†é…ç½®: ${apiConfigs[idx].name}`);
        }

        function updateConfig(idx, field, value) {
            apiConfigs[idx][field] = value;
            saveConfigs();
        }

        function updateCharCount(id) {
            const pair = inputPairs.find(p => p.id === id);
            if (pair) {
                const textarea = document.querySelector(`#input-${id}`);
                pair.text = textarea.value;
                document.querySelector(`#count-${id}`).textContent = `${pair.text.length} å­—`;
            }
        }

        function addInputPair() {
            inputPairs.push({id: nextId++, text: ''});
            outputPairs.push({id: inputPairs[inputPairs.length - 1].id, editable: '', full: ''});
            renderInputPairs();
            renderOutputPairs();
            addLog('æ·»åŠ è¾“å…¥æ¡†', `å½“å‰å…± ${inputPairs.length} ä¸ªè¾“å…¥æ¡†`);
        }

        function deleteInputPair(id) {
            const idx = inputPairs.findIndex(p => p.id === id);
            if (idx > -1 && inputPairs.length > 1) {
                inputPairs.splice(idx, 1);
                outputPairs.splice(idx, 1);
                renderInputPairs();
                renderOutputPairs();
                addLog('åˆ é™¤è¾“å…¥æ¡†', `å‰©ä½™ ${inputPairs.length} ä¸ªè¾“å…¥æ¡†`);
            }
        }

        function splitInputPair(id) {
            const idx = inputPairs.findIndex(p => p.id === id);
            if (idx === -1) return;

            const textarea = document.querySelector(`#input-${id}`);
            const text = textarea.value;
            const splitPos = Math.floor(text.length / 2);

            const firstHalf = text.substring(0, splitPos);
            const secondHalf = text.substring(splitPos);

            inputPairs[idx].text = firstHalf;
            inputPairs.splice(idx + 1, 0, {id: nextId++, text: secondHalf});
            outputPairs.splice(idx + 1, 0, {id: inputPairs[idx + 1].id, editable: '', full: ''});

            renderInputPairs();
            renderOutputPairs();
            addLog('åˆ‡åˆ†è¾“å…¥æ¡†', `è¾“å…¥ #${id + 1} å·²åˆ‡åˆ†ä¸ºä¸¤éƒ¨åˆ†`);

            setTimeout(() => {
                const firstTextarea = document.querySelector(`#input-${id}`);
                const secondTextarea = document.querySelector(`#input-${inputPairs[idx + 1].id}`);
                if (firstTextarea) {
                    firstTextarea.scrollTop = firstTextarea.scrollHeight;
                }
                if (secondTextarea) {
                    secondTextarea.scrollTop = 0;
                }
            }, 0);
        }

        function renderInputPairs() {
            const container = document.getElementById('inputPairs');
            container.innerHTML = inputPairs.map(pair => `
                <div class="input-pair">
                    <div class="input-header">
                        <span style="font-size: 14px; color: #718096; font-weight: 600;">è¾“å…¥ #${pair.id + 1}</span>
                        <span class="char-count" id="count-${pair.id}">${pair.text.length} å­—</span>
                    </div>
                    <textarea id="input-${pair.id}" oninput="updateCharCount(${pair.id})" placeholder="è¯·è¾“å…¥é¢˜ç›®éœ€æ±‚">${pair.text}</textarea>
                    <div class="input-actions">
                        <button class="small" onclick="splitInputPair(${pair.id})">âœ‚ï¸ åˆ‡åˆ†</button>
                        ${inputPairs.length > 1 ? `<button class="small danger" onclick="deleteInputPair(${pair.id})">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderOutputPairs() {
            const container = document.getElementById('outputPairs');
            container.innerHTML = outputPairs.map((pair, idx) => `
                <div class="output-pair">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; color: #718096; font-weight: 600;">è¾“å‡º #${pair.id + 1}</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="small" onclick="regenerateSingle(${pair.id})">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                            <button class="small" onclick="compareSingle(${pair.id})">ğŸ” å¯¹æ¯”å®¡æ ¸</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">ğŸ“ å¯ç¼–è¾‘ JSON</div>
                            <textarea class="output" id="editable-${pair.id}" onchange="validateJSON(${pair.id})" style="background: white; color: #2d3748; border: 2px solid #e2e8f0;" placeholder="ç­‰å¾…ç”Ÿæˆ...">${pair.editable}</textarea>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">ğŸ“„ å®Œæ•´è¾“å‡º</div>
                            <div class="output" id="full-${pair.id}">${pair.full || 'ç­‰å¾…ç”Ÿæˆ...'}</div>
                        </div>
                    </div>
                    <div id="compare-result-${pair.id}" style="margin-top: 10px; display: none;">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 8px; font-weight: 600;">ğŸ“Š å¯¹æ¯”ç»“æœ</div>
                        <div class="output" id="compare-output-${pair.id}">ç­‰å¾…å¯¹æ¯”...</div>
                    </div>
                </div>
            `).join('');
        }

        function exportInputs() {
            const data = {inputs: inputPairs.map(p => p.text)};
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'split_inputs.json';
            a.click();
            URL.revokeObjectURL(url);
            addLog('å¯¼å‡ºåˆ‡åˆ†', `å¯¼å‡ºäº† ${inputPairs.length} ä¸ªè¾“å…¥`);
        }

        function importInputs() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    inputPairs = data.inputs.map((text, i) => ({id: i, text}));
                    outputPairs = inputPairs.map(p => ({id: p.id, editable: '', full: ''}));
                    nextId = inputPairs.length;
                    renderInputPairs();
                    renderOutputPairs();
                    addLog('å¯¼å…¥åˆ‡åˆ†', `å¯¼å…¥äº† ${inputPairs.length} ä¸ªè¾“å…¥`);
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                    addLog('å¯¼å…¥åˆ‡åˆ†å¤±è´¥', err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function extractJSON(text) {
            const match = text.match(/```json\s*([\s\S]*?)\s*```/);
            return match ? match[1].trim() : '';
        }

        async function generateSingle(pairId, userInput) {
            const selectedApi = apiConfigs.find(c => c.selected);
            const idx = inputPairs.findIndex(p => p.id === pairId);
            if (idx === -1) return;

            outputPairs[idx].full = 'æ­£åœ¨ç”Ÿæˆä¸­...\n\n';
            outputPairs[idx].editable = '';
            const fullEl = document.getElementById(`full-${pairId}`);
            const editableEl = document.getElementById(`editable-${pairId}`);
            if (fullEl) fullEl.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­...\n\n';
            if (editableEl) editableEl.value = '';

            const isStreaming = document.getElementById('streamToggle').checked;
            const systemPrompt = document.getElementById('systemPrompt').value;

            addLog(`AIç”Ÿæˆé¢˜ç›® #${pairId + 1}`, `æ¨¡å‹: ${selectedApi.model}, é¢˜å‹: ${selectedTypes.join(', ')}, æµå¼: ${isStreaming ? 'æ˜¯' : 'å¦'}`);

            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apiUrl: selectedApi.url,
                    apiKey: selectedApi.key,
                    model: selectedApi.model,
                    questionTypes: selectedTypes,
                    userInput,
                    systemPrompt: systemPrompt,
                    directory: document.getElementById('directory').value
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        if (data.error) {
                            throw new Error(data.error);
                        } else if (data.text) {
                            fullText += data.text;
                            if (isStreaming) {
                                outputPairs[idx].full = fullText;
                                if (fullEl) {
                                    fullEl.textContent = fullText;
                                    fullEl.scrollTop = fullEl.scrollHeight;
                                }

                                const jsonContent = extractJSON(fullText);
                                if (jsonContent) {
                                    outputPairs[idx].editable = jsonContent;
                                    if (editableEl) {
                                        editableEl.value = jsonContent;
                                        editableEl.scrollTop = editableEl.scrollHeight;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if (!isStreaming) {
                outputPairs[idx].full = fullText;
                if (fullEl) fullEl.textContent = fullText;
                const jsonContent = extractJSON(fullText);
                if (jsonContent) {
                    outputPairs[idx].editable = jsonContent;
                    if (editableEl) editableEl.value = jsonContent;
                }
            }

            const jsonContent = extractJSON(fullText);
            const questionCount = jsonContent ? (JSON.parse(jsonContent).questions || []).length : 0;
            addLog(`AIç”Ÿæˆå®Œæˆ #${pairId + 1}`, `ç”Ÿæˆäº† ${questionCount} é“é¢˜ç›®, æ€»å­—ç¬¦: ${fullText.length}`);

            // è‡ªåŠ¨éªŒè¯ JSON æ ¼å¼
            validateJSON(pairId);
        }

        async function regenerateSingle(pairId) {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('é‡æ–°ç”Ÿæˆå¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            if (selectedTypes.length === 0) {
                error.textContent = 'âŒ è¯·é€‰æ‹©é¢˜å‹';
                error.style.display = 'block';
                addLog('é‡æ–°ç”Ÿæˆå¤±è´¥', 'æœªé€‰æ‹©é¢˜å‹');
                return;
            }

            const pair = inputPairs.find(p => p.id === pairId);
            if (!pair || !pair.text.trim()) {
                error.textContent = 'âŒ è¾“å…¥å†…å®¹ä¸ºç©º';
                error.style.display = 'block';
                addLog('é‡æ–°ç”Ÿæˆå¤±è´¥', 'è¾“å…¥å†…å®¹ä¸ºç©º');
                return;
            }

            addLog(`é‡æ–°ç”Ÿæˆ #${pairId + 1}`, 'å¼€å§‹é‡æ–°ç”Ÿæˆé¢˜ç›®');
            try {
                await generateSingle(pairId, pair.text);
            } catch (e) {
                error.textContent = `âŒ é”™è¯¯: ${e.message}`;
                error.style.display = 'block';
                addLog(`é‡æ–°ç”Ÿæˆå¼‚å¸¸ #${pairId + 1}`, e.message);
            }
        }

        async function generateQuestions() {
            const error = document.getElementById('error');
            const generateBtn = document.getElementById('generateBtn');
            const exportBtn = document.getElementById('exportBtn');

            error.style.display = 'none';
            error.textContent = '';
            exportBtn.disabled = true;

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('æ‰¹é‡ç”Ÿæˆå¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            if (selectedTypes.length === 0) {
                error.textContent = 'âŒ è¯·é€‰æ‹©é¢˜å‹';
                error.style.display = 'block';
                addLog('æ‰¹é‡ç”Ÿæˆå¤±è´¥', 'æœªé€‰æ‹©é¢˜å‹');
                return;
            }

            const hasInput = inputPairs.some(p => p.text.trim());
            if (!hasInput) {
                error.textContent = 'âŒ è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªéœ€æ±‚';
                error.style.display = 'block';
                addLog('æ‰¹é‡ç”Ÿæˆå¤±è´¥', 'è¾“å…¥å†…å®¹ä¸ºç©º');
                return;
            }

            generateBtn.disabled = true;
            const validInputCount = inputPairs.filter(p => p.text.trim()).length;
            addLog('å¼€å§‹æ‰¹é‡ç”Ÿæˆ', `å…± ${validInputCount} ä¸ªè¾“å…¥, é¢˜å‹: ${selectedTypes.join(', ')}`);

            const promises = inputPairs.map(pair => {
                if (!pair.text.trim()) return Promise.resolve();
                return generateSingle(pair.id, pair.text).catch(e => {
                    console.error(`ç”Ÿæˆå¤±è´¥ (è¾“å…¥ #${pair.id + 1}):`, e);
                    addLog(`ç”Ÿæˆå¼‚å¸¸ #${pair.id + 1}`, e.message);
                });
            });

            await Promise.all(promises);

            generateBtn.disabled = false;
            exportBtn.disabled = false;
            addLog('æ‰¹é‡ç”Ÿæˆå®Œæˆ', `æ‰€æœ‰ ${validInputCount} ä¸ªè¾“å…¥å·²å¤„ç†å®Œæˆ`);
        }

        async function exportExcel() {
            const error = document.getElementById('error');
            error.style.display = 'none';
            error.textContent = '';

            try {
                let allQuestions = [];
                for (const pair of outputPairs) {
                    const textarea = document.getElementById(`editable-${pair.id}`);
                    if (textarea && textarea.value.trim()) {
                        const jsonData = JSON.parse(textarea.value);
                        const questions = jsonData.questions || [];
                        allQuestions = allQuestions.concat(questions);
                    }
                }

                if (allQuestions.length === 0) {
                    error.textContent = 'âŒ æ²¡æœ‰å¯å¯¼å‡ºçš„é¢˜ç›®';
                    error.style.display = 'block';
                    addLog('å¯¼å‡ºExcelå¤±è´¥', 'æ²¡æœ‰å¯å¯¼å‡ºçš„é¢˜ç›®');
                    return;
                }

                const filename = document.getElementById('outputFilename').value || 'exam_questions';
                addLog('å¼€å§‹å¯¼å‡ºExcel', `æ–‡ä»¶å: ${filename}, é¢˜ç›®æ•°: ${allQuestions.length}`);

                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questions: allQuestions })
                });

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                addLog('å¯¼å‡ºExcelæˆåŠŸ', `å·²å¯¼å‡º ${allQuestions.length} é“é¢˜ç›®åˆ° ${filename}.xlsx`);
            } catch (e) {
                error.textContent = `âŒ å¯¼å‡ºå¤±è´¥: ${e.message}`;
                error.style.display = 'block';
                addLog('å¯¼å‡ºExcelå¼‚å¸¸', e.message);
            }
        }

        function removeNullValues(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => removeNullValues(item));
            } else if (obj !== null && typeof obj === 'object') {
                const newObj = {};
                for (const key in obj) {
                    if (obj[key] !== null) {
                        newObj[key] = removeNullValues(obj[key]);
                    }
                }
                return newObj;
            }
            return obj;
        }

        function validateJSON(pairId) {
            const editableEl = document.getElementById(`editable-${pairId}`);
            if (!editableEl) return;

            const jsonText = editableEl.value.trim();
            if (!jsonText) {
                editableEl.classList.remove('invalid');
                return;
            }

            try {
                const data = JSON.parse(jsonText);

                // æ£€æŸ¥æ˜¯å¦æœ‰ questions æ•°ç»„
                if (!data.questions || !Array.isArray(data.questions)) {
                    editableEl.classList.add('invalid');
                    addLog(`éªŒè¯å¤±è´¥ #${pairId + 1}`, 'ç¼ºå°‘ questions æ•°ç»„');
                    return;
                }

                // æ£€æŸ¥æ¯ä¸ªé¢˜ç›®çš„å¿…å¡«å­—æ®µ
                const requiredFields = ['é¢˜å¹²ï¼ˆå¿…å¡«ï¼‰', 'é¢˜å‹ ï¼ˆå¿…å¡«ï¼‰', 'æ­£ç¡®ç­”æ¡ˆ\nï¼ˆå¿…å¡«ï¼‰'];
                for (let i = 0; i < data.questions.length; i++) {
                    const q = data.questions[i];
                    for (const field of requiredFields) {
                        if (!q[field] || q[field].toString().trim() === '') {
                            editableEl.classList.add('invalid');
                            addLog(`éªŒè¯å¤±è´¥ #${pairId + 1}`, `é¢˜ç›® ${i + 1} ç¼ºå°‘å¿…å¡«å­—æ®µ: ${field}`);
                            return;
                        }
                    }
                }

                // éªŒè¯é€šè¿‡
                editableEl.classList.remove('invalid');
                addLog(`éªŒè¯é€šè¿‡ #${pairId + 1}`, `${data.questions.length} é“é¢˜ç›®æ ¼å¼æ­£ç¡®`);
            } catch (e) {
                editableEl.classList.add('invalid');
                addLog(`éªŒè¯å¤±è´¥ #${pairId + 1}`, 'JSON æ ¼å¼é”™è¯¯');
            }
        }

        function generateFileA() {
            try {
                let allQuestions = [];
                for (const pair of outputPairs) {
                    const textarea = document.getElementById(`editable-${pair.id}`);
                    if (textarea && textarea.value.trim()) {
                        const jsonData = JSON.parse(textarea.value);
                        const questions = jsonData.questions || [];
                        allQuestions = allQuestions.concat(questions);
                    }
                }

                if (allQuestions.length === 0) {
                    alert('âŒ æ²¡æœ‰å¯ç”Ÿæˆçš„é¢˜ç›®');
                    return;
                }

                const removeNull = document.getElementById('removeNullToggle').checked;
                let result = { questions: allQuestions };
                if (removeNull) {
                    result = removeNullValues(result);
                }

                document.getElementById('fileA').value = JSON.stringify(result, null, 2);
                document.getElementById('compareBtn').disabled = false;
                addLog('ç”Ÿæˆæ–‡ä»¶A', `é¢˜ç›®æ•°: ${allQuestions.length}, å»é™¤null: ${removeNull ? 'æ˜¯' : 'å¦'}`);
            } catch (e) {
                alert(`âŒ ç”Ÿæˆå¤±è´¥: ${e.message}`);
                addLog('ç”Ÿæˆæ–‡ä»¶Aå¤±è´¥', e.message);
            }
        }

        function generateFileB() {
            const allInputs = inputPairs.map(p => p.text).filter(t => t.trim()).join('\n\n');
            if (!allInputs) {
                alert('âŒ æ²¡æœ‰è¾“å…¥å†…å®¹');
                return;
            }

            document.getElementById('fileB').value = allInputs;
            document.getElementById('compareBtn').disabled = false;
            addLog('ç”Ÿæˆæ–‡ä»¶B', `è¾“å…¥æ•°: ${inputPairs.filter(p => p.text.trim()).length}`);
        }

        async function compareFiles() {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('AIå¯¹æ¯”å¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            const fileA = document.getElementById('fileA').value.trim();
            const fileB = document.getElementById('fileB').value.trim();

            if (!fileA || !fileB) {
                error.textContent = 'âŒ è¯·å…ˆç”Ÿæˆæ–‡ä»¶ A å’Œæ–‡ä»¶ B';
                error.style.display = 'block';
                addLog('AIå¯¹æ¯”å¤±è´¥', 'æ–‡ä»¶å†…å®¹ä¸ºç©º');
                return;
            }

            const compareBtn = document.getElementById('compareBtn');
            const resultEl = document.getElementById('compareResult');
            compareBtn.disabled = true;
            resultEl.textContent = 'æ­£åœ¨å¯¹æ¯”åˆ†æä¸­...\n\n';

            addLog('å¼€å§‹AIå¯¹æ¯”', `æ¨¡å‹: ${selectedApi.model}`);

            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiUrl: selectedApi.url,
                        apiKey: selectedApi.key,
                        model: selectedApi.model,
                        fileA: fileA,
                        fileB: fileB
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            if (data.error) {
                                throw new Error(data.error);
                            } else if (data.text) {
                                fullText += data.text;
                                resultEl.textContent = fullText;
                                resultEl.scrollTop = resultEl.scrollHeight;
                            }
                        }
                    }
                }

                addLog('AIå¯¹æ¯”å®Œæˆ', `è¾“å‡ºå­—ç¬¦æ•°: ${fullText.length}`);
            } catch (e) {
                error.textContent = `âŒ å¯¹æ¯”å¤±è´¥: ${e.message}`;
                error.style.display = 'block';
                addLog('AIå¯¹æ¯”å¼‚å¸¸', e.message);
            } finally {
                compareBtn.disabled = false;
            }
        }

        async function compareSingle(pairId) {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('å•ä¸ªå¯¹æ¯”å¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            const idx = inputPairs.findIndex(p => p.id === pairId);
            if (idx === -1) return;

            const inputText = inputPairs[idx].text.trim();
            const editableEl = document.getElementById(`editable-${pairId}`);
            const outputText = editableEl ? editableEl.value.trim() : '';

            if (!inputText || !outputText) {
                error.textContent = 'âŒ è¾“å…¥æˆ–è¾“å‡ºå†…å®¹ä¸ºç©º';
                error.style.display = 'block';
                addLog('å•ä¸ªå¯¹æ¯”å¤±è´¥', 'å†…å®¹ä¸ºç©º');
                return;
            }

            const removeNull = document.getElementById('removeNullToggle').checked;
            let fileA = outputText;
            if (removeNull) {
                try {
                    const jsonData = JSON.parse(outputText);
                    fileA = JSON.stringify(removeNullValues(jsonData), null, 2);
                } catch (e) {
                    fileA = outputText;
                }
            }

            const resultContainer = document.getElementById(`compare-result-${pairId}`);
            const resultEl = document.getElementById(`compare-output-${pairId}`);
            resultContainer.style.display = 'block';
            resultEl.textContent = 'æ­£åœ¨å¯¹æ¯”åˆ†æä¸­...\n\n';

            addLog(`å•ä¸ªå¯¹æ¯” #${pairId + 1}`, `æ¨¡å‹: ${selectedApi.model}`);

            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiUrl: selectedApi.url,
                        apiKey: selectedApi.key,
                        model: selectedApi.model,
                        fileA: fileA,
                        fileB: inputText
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            if (data.error) {
                                throw new Error(data.error);
                            } else if (data.text) {
                                fullText += data.text;
                                resultEl.textContent = fullText;
                                resultEl.scrollTop = resultEl.scrollHeight;
                            }
                        }
                    }
                }

                addLog(`å•ä¸ªå¯¹æ¯”å®Œæˆ #${pairId + 1}`, `è¾“å‡ºå­—ç¬¦æ•°: ${fullText.length}`);
            } catch (e) {
                error.textContent = `âŒ å¯¹æ¯”å¤±è´¥: ${e.message}`;
                error.style.display = 'block';
                addLog(`å•ä¸ªå¯¹æ¯”å¼‚å¸¸ #${pairId + 1}`, e.message);
            }
        }

        async function compareAllSingle() {
            const error = document.getElementById('error');
            error.style.display = 'none';

            const selectedApi = apiConfigs.find(c => c.selected);
            if (!selectedApi || !selectedApi.url || !selectedApi.key || !selectedApi.model) {
                error.textContent = 'âŒ è¯·å®Œæ•´å¡«å†™é€‰ä¸­çš„ API é…ç½®';
                error.style.display = 'block';
                addLog('ä¸€é”®å®¡æ ¸å¤±è´¥', 'APIé…ç½®ä¸å®Œæ•´');
                return;
            }

            const validPairs = inputPairs.filter(pair => {
                const inputText = pair.text.trim();
                const editableEl = document.getElementById(`editable-${pair.id}`);
                const outputText = editableEl ? editableEl.value.trim() : '';
                return inputText && outputText;
            });

            if (validPairs.length === 0) {
                error.textContent = 'âŒ æ²¡æœ‰å¯å®¡æ ¸çš„å†…å®¹';
                error.style.display = 'block';
                addLog('ä¸€é”®å®¡æ ¸å¤±è´¥', 'æ²¡æœ‰å¯å®¡æ ¸çš„å†…å®¹');
                return;
            }

            addLog('å¼€å§‹ä¸€é”®å®¡æ ¸', `å…± ${validPairs.length} ä¸ªè¾“å…¥éœ€è¦å®¡æ ¸`);

            for (const pair of validPairs) {
                await compareSingle(pair.id);
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            addLog('ä¸€é”®å®¡æ ¸å®Œæˆ', `å·²å®Œæˆ ${validPairs.length} ä¸ªè¾“å…¥çš„å®¡æ ¸`);
        }

        window.onload = async () => {
            await loadEncryptionKey();
            loadConfigs();
            renderInputPairs();
            renderOutputPairs();
            await loadSystemPrompt();
            await loadQuestionTypes();
            renderLogs();

            const isMinimized = localStorage.getItem('logMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('logPanel').classList.add('minimized');
                document.querySelector('.log-header-buttons button').textContent = '+';
            }

            addLog('é¡µé¢åŠ è½½', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        };
    </script>
</body>
</html>
